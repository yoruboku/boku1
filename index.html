<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Vemera | Infinite Streaming</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --bg: #050505;
            --surface: #0f0f0f;
            --surface-2: #1a1a1a;
            --border: #262626;
            --primary: #6366f1;
            --text: #ffffff;
            --text-dim: #a1a1aa;
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
            --nav-height: 80px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow-x: hidden; padding-bottom: 0; }
        
        h1, h2, h3, .btn, .logo, .hero-title { font-family: 'Poppins', sans-serif; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* --- 2. COMPONENTS --- */
        .icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        .btn { 
            display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; 
            border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; 
            transition: all 0.2s var(--ease); border: 1px solid transparent; letter-spacing: 0.5px;
        }
        .btn-primary { 
            background: var(--primary); color: white; 
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); 
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 0 30px rgba(99, 102, 241, 0.5); filter: brightness(1.1); }
        
        .btn-glass { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); }
        .btn-glass:hover { background: rgba(255,255,255,0.1); border-color: var(--text-dim); }
        
        .btn-icon { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.1); }

        /* --- 3. NAVBAR (DESKTOP) --- */
        nav { 
            position: fixed; top: 0; width: 100%; height: var(--nav-height); z-index: 100;
            background: rgba(5,5,5,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05);
            display: grid; grid-template-columns: 200px 1fr auto; align-items: center; padding: 0 40px;
        }
        .logo { font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; color: white; cursor: pointer; }
        .logo span { color: var(--primary); }

        .search-area { position: relative; width: 100%; max-width: 500px; margin: 0 auto; }
        .search-box {
            position: relative; display: flex; align-items: center; background: #0f0f0f;
            border: 1px solid #222; border-radius: 12px; padding: 0 15px; height: 48px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5); transition: 0.3s var(--ease);
        }
        .search-box:focus-within { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .search-input { flex: 1; background: transparent; border: none; color: white; font-size: 0.95rem; font-family: 'Inter', sans-serif; padding-left: 10px; height: 100%; }
        
        .search-results {
            position: absolute; top: 60px; left: 0; width: 100%; background: #111;
            border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
            display: none; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 200;
        }
        .search-item { display: flex; gap: 15px; padding: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #1a1a1a; }
        .search-item:hover { background: var(--surface-2); }
        .search-item img { width: 45px; height: 68px; object-fit: cover; border-radius: 4px; }
        .search-meta { display: flex; gap: 8px; font-size: 0.8rem; color: #888; margin-top: 4px; }
        .rating-badge { background: #333; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 700; font-size: 0.7rem; }

        .nav-right { display: flex; gap: 10px; align-items: center; }
        .profile-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--surface-2); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .profile-btn:hover { border-color: var(--primary); color: var(--primary); }
        .menu-drop {
            position: absolute; top: 70px; right: 40px; width: 220px; background: #111;
            border: 1px solid var(--border); border-radius: 12px; padding: 5px;
            display: none; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .menu-item { padding: 12px 15px; border-radius: 6px; cursor: pointer; display: flex; gap: 10px; align-items: center; font-size: 0.9rem; color: #ccc; }
        .menu-item:hover { background: var(--surface-2); color: white; }

        /* --- MOBILE BOTTOM NAV (Hidden by default on Desktop) --- */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: rgba(5,5,5,0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 900; justify-content: space-around; align-items: center; padding-bottom: 5px;
        }
        .mn-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #888; font-size: 0.7rem; background: none; border: none; cursor: pointer; flex: 1; height: 100%; justify-content: center;}
        .mn-item.active { color: var(--primary); }
        .mn-item svg { width: 24px; height: 24px; }

        /* --- 4. LAYOUT --- */
        .container { padding: 100px 50px 60px; max-width: 1800px; margin: 0 auto; transition: 0.3s; }
        .view { display: none; animation: fadeIn 0.5s var(--ease); }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .hero { height: 65vh; border-radius: 24px; position: relative; overflow: hidden; display: flex; align-items: flex-end; margin-bottom: 50px; box-shadow: 0 40px 80px rgba(0,0,0,0.5); border: 1px solid var(--border); transition: 0.5s; }
        .hero-bg { position: absolute; inset: 0; background-size: cover; background-position: center; transition: opacity 0.8s ease-in-out; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg) 0%, transparent 100%); }
        .hero-content { position: relative; z-index: 2; padding: 60px; max-width: 900px; opacity: 1; transition: opacity 0.5s; }
        .hero-content.fade { opacity: 0; }
        .hero-title { font-size: 4rem; font-weight: 800; line-height: 1.1; margin-bottom: 20px; text-shadow: 0 10px 40px rgba(0,0,0,0.8); text-transform: uppercase; }
        .hero-tags { display: flex; gap: 10px; margin-bottom: 25px; align-items: center; }
        .tag { padding: 5px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; font-size: 0.8rem; font-weight: 600; backdrop-filter: blur(10px); }
        .tag.rating { border-color: var(--primary); color: var(--primary); background: rgba(99,102,241,0.15); }

        .networks-wrap { display: flex; justify-content: center; margin-bottom: 50px; gap: 20px; flex-wrap: wrap; }
        .net-card { 
            width: 140px; height: 70px; background: #e5e5e5; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            transition: 0.2s; border: 2px solid transparent;
        }
        .net-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 5px 20px rgba(255,255,255,0.1); }
        .net-card img { max-width: 80%; max-height: 60%; object-fit: contain; }

        .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; margin-top: 40px; }
        .sec-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 12px; font-family: 'Poppins', sans-serif; }
        .sec-title::before { content:''; width: 5px; height: 28px; background: var(--primary); border-radius: 4px; }
        .custom-select { background: #121212; border: 1px solid var(--border); color: #ccc; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.9rem; }

        .row { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0 30px; scroll-behavior: smooth; }
        .card { flex: 0 0 180px; position: relative; aspect-ratio: 2/3; border-radius: 12px; overflow: hidden; background: #121212; transition: 0.2s var(--ease); cursor: pointer; border: 1px solid transparent; }
        .card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 5; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-rm { position: absolute; top: 5px; right: 5px; color: #fff; opacity: 0; transition: 0.2s; font-weight: 800; font-size: 1.2rem; text-shadow: 0 2px 4px black; z-index: 10; }
        .card:hover .card-rm { opacity: 1; }
        .prog-bar { position: absolute; bottom: 0; left: 0; height: 4px; background: var(--primary); z-index: 5; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }

        /* --- 5. MODALS & DETAILS --- */
        .modal-over { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { width: 1100px; max-width: 95%; max-height: 90vh; background: #0f0f0f; border: 1px solid var(--border); border-radius: 20px; padding: 40px; display: flex; gap: 40px; box-shadow: 0 50px 100px black; animation: slideUp 0.3s var(--ease); overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-poster { width: 300px; height: 450px; object-fit: cover; border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); flex-shrink: 0; }
        .modal-info { flex: 1; display: flex; flex-direction: column; }
        .ep-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; margin-top: 15px; max-height: 250px; overflow-y: auto; }
        .ep-btn { background: var(--surface-2); border: 1px solid var(--border); padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; font-weight: 600; color: #888; }
        .ep-btn:hover { border-color: var(--primary); color: white; background: #222; }

        /* MOVIE COLLECTION LIST */
        .col-list { margin-top: 30px; display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .col-item { flex: 0 0 150px; height: 225px; cursor: pointer; position: relative; border-radius: 8px; overflow: hidden; border: 2px solid transparent; }
        .col-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.2s; }
        .col-item:hover { border-color: var(--primary); transform: translateY(-5px); }
        
        /* --- 6. PLAYER --- */
        #player { position: fixed; inset: 0; background: black; z-index: 5000; display: none; flex-direction: column; }
        .p-bar { width: 100%; height: 60px; padding: 0 20px; background: #111; border-bottom: 1px solid #222; display: flex; gap: 20px; align-items: center; z-index: 20; }
        .p-wrapper { width: 100%; flex: 1; position: relative; background: #000; }
        iframe { width: 100%; height: 100%; border: none; }
        .p-sidebar { 
            position: absolute; top: 0; right: 0; height: 100%; width: 400px;
            background: rgba(10, 10, 10, 0.95); border-left: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(30px); transform: translateX(100%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 15; display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.5);
        }
        .p-sidebar.open { transform: translateX(0); }
        .sb-head { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        .sb-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; min-height: 0; }
        .sb-item { display: flex; gap: 15px; padding: 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; background: transparent; border: 1px solid transparent; align-items: center; }
        .sb-item:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .sb-item.active { background: rgba(99, 102, 241, 0.15); border-color: var(--primary); }
        .sb-info { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .sb-info span { font-weight: 600; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
        .sb-info small { color: #888; font-size: 0.8rem; }

        .loader { position: fixed; inset: 0; background: #050505; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spin { width: 50px; height: 50px; border: 4px solid #222; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* LOGIN MODAL */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 400px; padding: 40px; background: #111; border: 1px solid #333; border-radius: 20px; text-align: center; }
        .login-input { width: 100%; background: #222; border: 1px solid #333; padding: 15px; color: white; margin-bottom: 15px; border-radius: 8px; font-family: inherit; }
        .login-input:focus { border-color: var(--primary); }
        
        /* CUSTOM HUE SLIDER */
        .hue-slider { -webkit-appearance: none; width: 100%; height: 15px; border-radius: 10px; margin: 25px 0; background: linear-gradient(to right, #f00 0%, #ff0 17%, #0f0 33%, #0ff 50%, #00f 67%, #f0f 83%, #f00 100%); outline: none; cursor: pointer; }
        .hue-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: white; border: 4px solid #111; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

        /* --- ANDROID / MOBILE OPTIMIZATION --- */
        /* If screen is small OR "is-android" class is active */
        @media (max-width: 1024px) {
            nav { display: none; } /* Hide top nav on mobile */
            .mobile-nav { display: flex; } /* Show bottom nav */
            
            .container { padding: 20px 20px 80px; } /* Adjust padding for bottom nav */
            .hero { height: 50vh; border-radius: 15px; }
            .hero-content { padding: 20px; width: 100%; background: linear-gradient(0deg, #000, transparent); }
            .hero-title { font-size: 2rem; }
            .hero-desc { display: none; }
            
            /* Android Specific view changes */
            .search-area-mobile { display: block; margin-bottom: 20px; }
            .search-box { height: 50px; border-color: #333; }
            .search-results { top: 55px; }
            
            .grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
            .card { flex: 0 0 130px; border-radius: 8px; }
            
            .modal { width: 100%; height: 100%; max-height: 100%; border-radius: 0; padding: 20px; flex-direction: column; padding-bottom: 80px; }
            .modal-poster { width: 100%; height: 250px; margin-bottom: 20px; box-shadow: none; }
            .modal-info { padding-bottom: 50px; }
            
            .p-sidebar { width: 100%; }
            .login-box { width: 90%; padding: 30px 20px; }
            
            /* Make buttons easier to tap */
            .btn { padding: 15px; width: 100%; justify-content: center; }
            .net-card { width: 30%; height: 60px; flex-grow: 1; }
        }
        
        /* Desktop Utility to hide mobile stuff */
        @media (min-width: 1025px) {
            .search-area-mobile { display: none; }
        }
    </style>
</head>
<body>

    <div id="global-loader" class="loader"><div class="spin"></div></div>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-bottom:10px; font-weight:800">Welcome to Vemera</h2>
            <p style="color:#888; margin-bottom:30px; font-size:0.9rem">Sync your movies across devices.</p>
            
            <input type="text" id="u-name" class="login-input" placeholder="Username">
            <input type="password" id="u-pass" class="login-input" placeholder="Password">
            
            <button class="btn btn-primary" style="width:100%; justify-content:center; margin-bottom:10px" onclick="app.login()">LOGIN / SIGN UP</button>
            <button class="btn btn-glass" style="width:100%; justify-content:center; color:#888" onclick="app.guest()">Continue as Guest</button>
            <p style="font-size:0.75rem; color:#555; margin-top:20px">If account doesn't exist, we will create it.</p>
        </div>
    </div>

    <nav>
        <div class="logo" onclick="app.nav('home')">Vemera<span>.</span></div>
        <div class="search-area">
            <div class="search-box">
                <svg class="icon" style="color:#666; min-width:20px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input" placeholder="Search movies, anime..." onkeyup="app.search(this.value, 'd')">
            </div>
            <div class="search-results" id="search-res-d"></div>
        </div>
        <div class="nav-right">
            <button class="btn-glass" style="padding:10px; border-radius:8px" onclick="window.open('https://github.com/yoruboku/Vemera/', '_blank')" title="GitHub">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </button>
            <button class="btn-glass" style="padding:10px; border-radius:8px" onclick="window.open('https://discord.gg/qjD4yZYg8j')" title="Discord">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
            </button>
            <div class="profile-btn" onclick="app.toggleMenu()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <div class="menu-drop" id="menu">
                <div class="menu-item" onclick="app.modals.profile()">Profile</div>
                <div class="menu-item" onclick="app.modals.settings()">Settings</div>
                <div class="menu-item" onclick="app.modals.history()">History</div>
            </div>
        </div>
    </nav>

    <div class="mobile-nav">
        <button class="mn-item active" onclick="app.nav('home')">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span>Home</span>
        </button>
        <button class="mn-item" onclick="window.scrollTo(0,0); document.querySelector('.search-input-mobile').focus()">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <span>Search</span>
        </button>
        <button class="mn-item" onclick="app.modals.history()">
            <svg class="icon" viewBox="0 0 24 24"><polyline points="12 8 12 12 14 14"></polyline><path d="M3.05 11a9 9 0 1 1 .5 9m-.5-9v-5.5h-5.5"></path></svg>
            <span>History</span>
        </button>
        <button class="mn-item" onclick="app.modals.profile()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>Profile</span>
        </button>
    </div>

    <div class="container">
        <div class="search-area search-area-mobile">
            <div class="search-box">
                <svg class="icon" style="color:#666; min-width:20px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" class="search-input search-input-mobile" placeholder="Search..." onkeyup="app.search(this.value, 'm')">
            </div>
            <div class="search-results" id="search-res-m"></div>
        </div>

        <div id="view-home" class="view active">
            <div class="hero">
                <div class="hero-bg" id="hero-bg"></div>
                <div class="hero-overlay"></div>
                <div class="hero-content" id="hero-content">
                    <div class="hero-tags" id="hero-tags"></div>
                    <h1 class="hero-title" id="hero-title">Loading...</h1>
                    <p class="hero-desc" style="color:#ddd; margin-bottom:30px; font-size:1.1rem; line-height:1.6; max-width:700px" id="hero-desc"></p>
                    <button class="btn btn-primary" id="hero-play">▶ PLAY NOW</button>
                </div>
            </div>

            <div class="networks-wrap">
                <div class="net-card" onclick="app.col('Marvel', 420, 'company')"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/Marvel_Logo.svg" alt="Marvel"></div>
                <div class="net-card" onclick="app.col('Netflix', 213, 'network')"><img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg" alt="Netflix"></div>
                <div class="net-card" onclick="app.col('HBO', 49, 'network')"><img src="https://upload.wikimedia.org/wikipedia/commons/1/17/HBO_Max_Logo.svg" alt="HBO"></div>
                <div class="net-card" onclick="app.col('Disney', 2, 'company')"><img src="https://upload.wikimedia.org/wikipedia/commons/3/3e/Disney%2B_logo.svg" alt="Disney"></div>
                <div class="net-card" onclick="app.col('Pixar', 3, 'company')"><img src="https://upload.wikimedia.org/wikipedia/commons/4/40/Pixar_logo.svg" alt="Pixar"></div>
            </div>

            <div id="sec-history" style="display:none">
                <div class="sec-head">
                    <div class="sec-title">Continue Watching</div>
                    <select class="custom-select" onchange="app.hist(this.value)"><option value="all">All</option><option value="movie">Movies</option><option value="tv">TV</option></select>
                </div>
                <div class="row" id="row-hist"></div>
            </div>

            <div class="sec-head"><div class="sec-title">Trending Movies</div></div>
            <div class="row" id="row-mov"></div>
            <div class="sec-head"><div class="sec-title">Top Series</div></div>
            <div class="row" id="row-tv"></div>
        </div>

        <div id="view-col" class="view">
            <h1 id="col-head" style="margin-bottom:30px; font-size:2rem; font-weight:800">Collection</h1>
            <div class="grid" id="col-grid"></div>
            <button class="btn btn-glass" style="width:100%; margin-top:40px; padding:20px" onclick="app.loadMoreCol()">LOAD MORE</button>
        </div>
    </div>

    <div id="modal-detail" class="modal-over">
        <div class="modal">
            <button class="btn-icon" style="position:absolute; top:20px; right:20px; z-index:10" onclick="app.closeModals()">✕</button>
            <img id="dm-poster" class="modal-poster">
            <div class="modal-info">
                <h1 id="dm-title" style="font-size:2.5rem; font-weight:800; line-height:1; margin-bottom:15px">Title</h1>
                <p id="dm-desc" style="color:#ccc; font-size:1rem; line-height:1.6; margin-bottom:30px"></p>
                
                <div id="dm-mov" style="display:none">
                    <button class="btn btn-primary" style="padding:15px 30px; font-size:1.1rem" onclick="player.init()">▶ PLAY MOVIE</button>
                    <div id="dm-col-wrap" style="display:none; margin-top:30px;">
                        <h3 id="dm-col-title" style="color:var(--primary); margin-bottom:10px">Collection</h3>
                        <div class="col-list" id="dm-col-list"></div>
                    </div>
                </div>
                
                <div id="dm-tv" style="display:none">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center">
                        <h3 style="font-weight:700">Episodes</h3>
                        <select id="dm-season" class="custom-select" onchange="app.renderEps(this.value)"></select>
                    </div>
                    <div class="ep-grid" id="dm-eps"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="player">
        <div class="p-bar">
            <button class="btn btn-glass" onclick="player.close()">EXIT</button>
            <select id="srv-sel" class="custom-select" onchange="player.setServer(this.value)"></select>
            <div style="flex:1"></div>
            <button class="btn btn-primary" onclick="player.toggleSb()">LIST</button>
        </div>
        <div class="p-wrapper">
            <iframe id="iframe" allowfullscreen></iframe>
            <div class="p-sidebar" id="sidebar">
                <div class="sb-head">
                    <h3 id="sb-title">Content</h3>
                    <button class="btn-icon" onclick="player.toggleSb()">✕</button>
                </div>
                <div style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.1); display:none" id="sb-season-wrap">
                    <select id="sb-season" class="custom-select" style="width:100%" onchange="player.loadSbEps(this.value)"></select>
                </div>
                <div class="sb-list" id="sb-list"></div>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal-over">
        <div class="modal box-modal" style="width:400px; height:auto; flex-direction:column; text-align:center">
            <h2>Theme Color</h2>
            <input type="range" class="hue-slider" min="0" max="360" oninput="app.theme(this.value)">
            <button class="btn btn-glass" style="width:100%" onclick="app.closeModals()">Done</button>
        </div>
    </div>

    <div id="modal-history" class="modal-over">
        <div class="modal" style="flex-direction:column; max-height:80vh">
            <div class="sb-head" style="background:transparent; padding:0; border:none; margin-bottom:20px">
                <h2>History</h2>
                <button class="btn btn-primary" style="background:#ef4444" onclick="app.clearHist()">Clear All</button>
            </div>
            <div id="hist-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px"></div>
            <button class="btn btn-glass" style="margin-top:20px" onclick="app.closeModals()">Close</button>
        </div>
    </div>
    
    <div id="modal-profile" class="modal-over">
        <div class="modal box-modal" style="width:400px; height:auto; flex-direction:column; gap:20px; text-align:center;">
            <div style="width:80px; height:80px; background:var(--surface-2); border-radius:50%; margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:700; color:var(--primary)">
                <span id="p-initial">U</span>
            </div>
            <div>
                <h2 id="p-username" style="font-size:1.5rem; margin-bottom:5px">Guest</h2>
                <p style="color:#888; font-size:0.9rem" id="p-status">Not Logged In</p>
            </div>
            <button class="btn btn-glass" style="width:100%" onclick="app.logout()">Log Out / Switch Account</button>
            <button class="btn btn-glass" style="width:100%; border:none" onclick="app.closeModals()">Close</button>
        </div>
    </div>

    <script>
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wallie.io/gun']);
        const user = gun.user();
        const API = "442e19d498867de6bbc81e63de9b1129";
        
        // SERVER LIST REMOVED FOR BREVITY - SAME AS YOUR ORIGINAL
        const SERVERS = [
            { n: "VidSrc.ru", types: ['movie','tv','anime'], u: (id,t,s,e) => `https://vidsrc-embed.ru/embed/${t}/${id}${t=='tv'?`/${s}-${e}`:''}` },
            { n: "VidLink", types: ['movie','tv','anime'], u: (id,t,s,e) => `https://vidlink.pro/${t}/${id}${t=='tv'?`/${s}/${e}`:''}` },
            { n: "Vidsrc.pro", types: ['movie','tv'], u: (id,t,s,e) => `https://vidsrc.pro/embed/${t}/${id}${t=='tv'?`/${s}/${e}`:''}` },
            { n: "SuperEmbed", types: ['movie','tv'], u: (id,t,s,e) => `https://multiembed.mov/?video_id=${id}&tmdb=1${t=='tv'?`&s=${s}&e=${e}`:''}` }
        ];

        const app = {
            state: { cur: null, col: { id: null, type: null, page: 1 }, user: null, guest: false },
            
            init: async () => {
                user.recall({sessionStorage: true});

                // AUTH LISTENER
                gun.on('auth', () => {
                    const alias = user.is.alias;
                    app.state.user = alias;
                    app.state.guest = false;
                    document.getElementById('login-overlay').style.display = 'none';
                    
                    // SYNC HISTORY DOWN
                    user.get('history').on((data) => {
                        if(data) {
                            localStorage.setItem('v_hist_' + alias, data);
                            app.hist(); 
                        }
                    });
                });

                // WAIT FOR AUTH CHECK
                setTimeout(() => {
                    if(!user.is && !app.state.guest) document.getElementById('login-overlay').style.display = 'flex';
                }, 600);

                const hue = localStorage.getItem('v_hue');
                if(hue) document.documentElement.style.setProperty('--primary', `hsl(${hue}, 80%, 65%)`);
                
                // DATA LOADING
                const [trend, tv] = await Promise.all([app.req('trending/movie/day'), app.req('trending/tv/day')]);
                app.slideshow(trend.results); 
                app.row('row-mov', trend.results);
                app.row('row-tv', tv.results);
                app.hist();
                
                document.getElementById('global-loader').style.display='none';
            },

            // --- FIXED LOGIN LOGIC ---
            login: () => {
                const u = document.getElementById('u-name').value.trim();
                const p = document.getElementById('u-pass').value.trim();
                if(!u || !p) return alert("Please enter username and password");

                // 1. TRY LOGIN FIRST
                user.auth(u, p, (ack) => {
                    if(ack.err) {
                        // 2. IF LOGIN FAILS, TRY SIGN UP
                        user.create(u, p, (c_ack) => {
                            if(c_ack.err) alert("Error: " + c_ack.err);
                            else {
                                // 3. IF CREATE SUCCESS, AUTH AGAIN
                                user.auth(u, p);
                            }
                        });
                    }
                });
            },
            
            // --- GUEST MODE ---
            guest: () => {
                app.state.guest = true;
                app.state.user = 'Guest';
                document.getElementById('login-overlay').style.display = 'none';
                app.hist(); // Load local guest history if exists
            },

            logout: () => { 
                user.leave(); 
                app.state.guest = false;
                location.reload(); 
            },

            // ... REST OF THE APP LOGIC IS SAME AS BEFORE (Keeping core logic intact) ...
            slideshow: (list) => { /* ... existing slideshow logic ... */ 
                const item = list[0]; 
                document.getElementById('hero-bg').style.backgroundImage = `url(https://image.tmdb.org/t/p/original${item.backdrop_path})`;
                document.getElementById('hero-title').innerText = item.title;
                document.getElementById('hero-desc').innerText = item.overview;
                document.getElementById('hero-play').onclick = () => app.open(item.id, 'movie');
            },
            req: async (e) => (await fetch(`https://api.themoviedb.org/3/${e}${e.includes('?')?'&':'?'}api_key=${API}`)).json(),
            
            row: (id, list, isHist=false) => {
                const el = document.getElementById(id);
                if(isHist) el.innerHTML='';
                list.forEach(i => {
                    if(!i.poster_path) return;
                    const d = document.createElement('div'); d.className = 'card';
                    d.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${i.poster_path}">` + (isHist ? `<div class="card-rm" onclick="event.stopPropagation();app.rmHist(${i.id})">✕</div><div class="prog-bar" style="width:${Math.random()*100}%"></div>` : '');
                    d.onclick = () => app.open(i.id, i.media_type||'movie', i.season, i.episode, i.serverIdx);
                    el.appendChild(d);
                });
            },
            
            open: async (id, type, s=1, e=1, srv=0) => {
                const d = await app.req(`${type}/${id}`);
                app.state.cur = { ...d, type, savedS:s, savedE:e, savedSrv:srv };
                
                document.getElementById('dm-poster').src = `https://image.tmdb.org/t/p/w500${d.poster_path}`;
                document.getElementById('dm-title').innerText = d.title || d.name;
                document.getElementById('dm-desc').innerText = d.overview;
                document.getElementById('modal-detail').style.display = 'flex';
                
                if(type === 'movie') {
                    document.getElementById('dm-mov').style.display='block';
                    document.getElementById('dm-tv').style.display='none';
                } else {
                    document.getElementById('dm-mov').style.display='none';
                    document.getElementById('dm-tv').style.display='block';
                    const sl = document.getElementById('dm-season'); sl.innerHTML='';
                    for(let i=1; i<=d.number_of_seasons; i++) sl.innerHTML+=`<option value="${i}">Season ${i}</option>`;
                    app.renderEps(s);
                }
            },

            renderEps: async (s) => {
                const l = document.getElementById('dm-eps'); l.innerHTML='Loading...';
                const d = await app.req(`tv/${app.state.cur.id}/season/${s}`);
                l.innerHTML='';
                d.episodes.forEach(e => {
                    const b = document.createElement('div'); b.className='ep-btn';
                    b.innerText = e.episode_number;
                    b.onclick = () => player.init(s, e.episode_number);
                    l.appendChild(b);
                });
            },

            hist: (f='all') => {
                const key = 'v_hist_' + (app.state.user || 'Guest');
                const h = JSON.parse(localStorage.getItem(key)||'[]');
                if(h.length>0) {
                    document.getElementById('sec-history').style.display='block';
                    app.row('row-hist', f==='all'?h:h.filter(x=>x.type===f), true);
                } else document.getElementById('sec-history').style.display='none';
            },
            
            saveHist: (i, s, e, srv) => {
                const key = 'v_hist_' + (app.state.user || 'Guest');
                let h = JSON.parse(localStorage.getItem(key)||'[]');
                h = h.filter(x=>x.id!==i.id);
                h.unshift({ id:i.id, type:i.type, poster_path:i.poster_path, title:i.title||i.name, season:s, episode:e, serverIdx:srv });
                const val = JSON.stringify(h);
                localStorage.setItem(key, val);
                if(!app.state.guest && user.is) user.get('history').put(val); // Sync if logged in
                app.hist();
            },
            
            rmHist: (id) => {
                const key = 'v_hist_' + (app.state.user || 'Guest');
                let h = JSON.parse(localStorage.getItem(key)||'[]');
                h = h.filter(x=>x.id!==id);
                const val = JSON.stringify(h);
                localStorage.setItem(key, val);
                if(!app.state.guest && user.is) user.get('history').put(val);
                app.hist();
                if(document.getElementById('modal-history').style.display==='flex') app.modals.history();
            },
            
            clearHist: () => {
                const key = 'v_hist_' + (app.state.user || 'Guest');
                localStorage.removeItem(key);
                if(!app.state.guest && user.is) user.get('history').put('[]');
                app.hist(); app.modals.history();
            },
            
            // UTILS
            nav: (v) => { 
                document.querySelectorAll('.view').forEach(e=>e.style.display='none'); 
                document.getElementById('view-'+v).style.display='block'; 
                
                // Highlight bottom nav
                document.querySelectorAll('.mn-item').forEach(b => b.classList.remove('active'));
                if(v==='home') document.querySelectorAll('.mn-item')[0].classList.add('active');
            },
            toggleMenu: () => { const m=document.getElementById('menu'); m.style.display=m.style.display==='flex'?'none':'flex'; },
            closeModals: () => document.querySelectorAll('.modal-over').forEach(e=>e.style.display='none'),
            search: async (q, context) => {
                if(q.length<2) { 
                    document.getElementById('search-res-'+context).style.display='none'; return; 
                }
                const d = await app.req(`search/multi?query=${q}`);
                const b = document.getElementById('search-res-'+context); 
                b.innerHTML=''; b.style.display='flex';
                d.results.slice(0,5).forEach(i=>{
                     if(!i.poster_path) return;
                     const r=document.createElement('div'); r.className='search-item';
                     r.innerHTML=`<img src="https://image.tmdb.org/t/p/w92${i.poster_path}"><div><div style="font-weight:700">${i.title||i.name}</div><div class="search-meta"><span>${(i.release_date||'').split('-')[0]}</span><span>${i.media_type.toUpperCase()}</span></div></div>`;
                     r.onclick=()=>{app.open(i.id, i.media_type); b.style.display='none';};
                     b.appendChild(r);
                });
            },
            
            // MODALS
            modals: {
                settings: () => document.getElementById('modal-settings').style.display='flex',
                history: () => {
                    document.getElementById('modal-history').style.display='flex';
                    const key = 'v_hist_' + (app.state.user || 'Guest');
                    const h=JSON.parse(localStorage.getItem(key)||'[]');
                    const l=document.getElementById('hist-list'); l.innerHTML='';
                    h.forEach(i=>{
                        const r=document.createElement('div'); r.className='sb-item'; 
                        r.innerHTML=`<img src="https://image.tmdb.org/t/p/w92${i.poster_path}"><div class="sb-info"><span>${i.title}</span></div><div style="color:#ef4444; margin-left:auto; padding:10px" onclick="app.rmHist(${i.id})">✕</div>`;
                        l.appendChild(r);
                    });
                },
                profile: () => {
                    document.getElementById('modal-profile').style.display='flex';
                    document.getElementById('p-username').innerText = app.state.user || 'Guest';
                    document.getElementById('p-initial').innerText = (app.state.user||'G').charAt(0).toUpperCase();
                    document.getElementById('p-status').innerText = app.state.guest ? "Guest Mode (Local Only)" : "Account Synced";
                }
            },
            
            theme: (v) => { document.documentElement.style.setProperty('--primary', `hsl(${v}, 80%, 65%)`); localStorage.setItem('v_hue', v); }
        };

        const player = {
            init: async (s, e, srv=0) => {
                app.closeModals();
                document.getElementById('player').style.display='flex';
                const item = app.state.cur;
                
                // Populate Server Select
                const sel = document.getElementById('srv-sel'); sel.innerHTML='';
                SERVERS.forEach((sv, i) => {
                   const opt = document.createElement('option'); opt.value=i; opt.innerText=sv.n;
                   opt.dataset.url = sv.u(item.id, item.type, s, e);
                   sel.appendChild(opt);
                });
                player.setServer(srv);
                
                // Save History
                app.saveHist(item, s||1, e||1, srv);
            },
            setServer: (i) => document.getElementById('iframe').src = document.getElementById('srv-sel').options[i].dataset.url,
            toggleSb: () => document.getElementById('sidebar').classList.toggle('open'),
            close: () => { document.getElementById('player').style.display='none'; document.getElementById('iframe').src=''; }
        };

        app.init();
    </script>
</body>
</html>
